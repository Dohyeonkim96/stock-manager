<style>
  .plan-input-container { max-width: 1200px; margin: 0 auto; }
  .item-row-header { display: none; grid-template-columns: 1fr 1.5fr 1.5fr 2fr 0.8fr max-content; gap: 8px 16px; font-weight: bold; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); color: var(--label-color); }
  .item-row { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 24px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 0.25rem; }
  .calendar-controls { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; margin-bottom: 16px; }
  #calendarDisplay table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 16px; border: 1px solid var(--border-color); }
  #calendarDisplay th, #calendarDisplay td { border: 1px solid var(--border-color); padding: 4px; text-align: left; height: 110px; vertical-align: top; font-size: 0.8rem; }
  #calendarDisplay th { background-color: #f5f5f5; text-align:center; padding: 8px 0; }
  #calendarDisplay td .day-number { font-weight: bold; text-align:right; padding-right: 4px;}
  #calendarDisplay td .plan-item-wrapper { max-height: calc(110px - 20px); overflow-y:auto; }
  #calendarDisplay td .plan-item { font-size: 0.9em; margin-bottom: 3px; background-color: var(--info-color); color: white; padding: 4px 6px; border-radius: 0.25rem; cursor: pointer; word-break: break-all; }
  .other-month { background-color: #fafafa; }
  @media (min-width: 1201px) {
    .item-row-header { display: grid; }
    .item-row { grid-template-columns: 1fr 1.5fr 1.5fr 2fr 0.8fr max-content; border: none; padding: 0 0 8px 0; border-bottom: 1px dashed var(--border-color); border-radius: 0; }
    .item-row .form-group .field-label { display: none; }
  }
</style>

<div class="section-card">
  <h1 class="page-main-title">생산 계획 관리</h1>
  <div class="form-section" style="border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 16px; margin-bottom: 24px;">
    <h2 class="section-title">새 계획 입력</h2>
    <div class="plan-input-container">
      <div class="item-row-header"><div>생산일*</div><div>지에스켐 품번*</div><div>유한품번</div><div>품명</div><div>수량*</div><div>삭제</div></div>
      <div id="planItemsContainer"></div>
    </div>
    <div style="display: flex; gap: 8px; margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 16px;">
      <button type="button" class="button-primary" onclick="submitNewProductionPlans()">계획 등록</button>
      <button type="button" class="button-secondary" onclick="addPlanItemEntry()">새 품목 추가</button>
    </div>
  </div>
  <div id="monthlyCalendarArea" style="margin-top: 32px;">
    <h2 class="section-title">월간 생산계획</h2>
    <div class="calendar-controls">
      <div class="form-group" style="margin:0; flex-direction:row; align-items:center;">
        <label for="calendarMonth" style="margin:0 4px 0 0;">조회 월:</label>
        <input type="month" id="calendarMonth" class="editable" onchange="loadCalendarData()">
      </div>
      <button class="button-secondary" onclick="loadCalendarData()">새로고침</button>
    </div>
    <div id="calendarDisplay"></div>
  </div>
</div>
<script>
  const state = { calendarPlans: [] };

  (function(){
    const today = new Date();
    document.getElementById('calendarMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    addPlanItemEntry();
    loadCalendarData();
  })();

  function addPlanItemEntry() {
    const newItemRow = document.createElement('div');
    newItemRow.className = 'item-row';
    newItemRow.innerHTML = `
      <div class="form-group"><label class="field-label">생산일*</label><input type="date" name="productionDate" class="editable" value="${new Date().toISOString().slice(0, 10)}"></div>
      <div class="form-group"><label class="field-label">지에스켐 품번*</label><input type="text" name="gskemPartNo" class="editable" onchange="fetchProductDetails(this.closest('.item-row'))"></div>
      <div class="form-group"><label class="field-label">유한품번</label><input type="text" name="yuhanPartNo" readonly></div>
      <div class="form-group"><label class="field-label">품명</label><input type="text" name="itemName" readonly></div>
      <div class="form-group"><label class="field-label">수량*</label><input type="number" name="quantity" min="1" class="editable" value="1"></div>
      <div><button type="button" class="button-danger" onclick="this.closest('.item-row').remove()">삭제</button></div>`;
    document.getElementById('planItemsContainer').appendChild(newItemRow);
  }

  async function fetchProductDetails(row) {
    const gskemPartNo = row.querySelector(`[name='gskemPartNo']`).value.trim();
    if (!gskemPartNo) return;
    try {
        const response = await fetch(`/.netlify/functions/getProductInfoByGSKEM?gskemPartNo=${gskemPartNo}`);
        const data = await response.json();
        if(!response.ok) throw new Error(data.error);
        row.querySelector(`[name='yuhanPartNo']`).value = data['유한 품번'] || '';
        row.querySelector(`[name='itemName']`).value = data['품명'] || '해당 품번 없음';
    } catch(err) { showMessage(err.message, 'error'); }
  }

  async function submitNewProductionPlans() {
    const items = Array.from(document.querySelectorAll('#planItemsContainer .item-row')).map(row => ({
      productionDate: row.querySelector('[name="productionDate"]').value,
      itemName: row.querySelector('[name="itemName"]').value.trim(),
      quantity: Number(row.querySelector('[name="quantity"]').value),
      gskemPartNo: row.querySelector('[name="gskemPartNo"]').value.trim(),
      yuhanPartNo: row.querySelector('[name="yuhanPartNo"]').value.trim(),
    })).filter(item => item.itemName && item.itemName !== "해당 품번 없음" && item.quantity > 0);
    
    if (items.length === 0) { showMessage('저장할 유효한 품목이 없습니다.', 'error'); return; }
    
    showMessage('계획 등록 중...', 'info');
    try {
        const response = await fetch(`/.netlify/functions/manageProductionPlan`, {
            method: 'POST', body: JSON.stringify(items)
        });
        const res = await response.json();
        if(!response.ok) throw new Error(res.message);
        showMessage(res.message, 'success');
        document.getElementById('planItemsContainer').innerHTML = '';
        addPlanItemEntry();
        loadCalendarData();
    } catch(err) { showMessage(err.message, 'error'); }
  }

  async function loadCalendarData() {
    const [year, month] = document.getElementById('calendarMonth').value.split('-');
    showMessage('달력 데이터를 로드 중입니다...', 'info');
    try {
        const response = await fetch(`/.netlify/functions/getProductionPlans?year=${year}&month=${month}`);
        if(!response.ok) throw new Error('달력 데이터 로드 실패');
        const plans = await response.json();
        state.calendarPlans = plans || [];
        renderCalendar(parseInt(year), parseInt(month), state.calendarPlans);
    } catch(err) { showMessage(err.message, 'error'); }
  }
  
  function renderCalendar(year, month, plans) {
    const calendarDiv = document.getElementById('calendarDisplay');
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    
    let html = `<table><thead><tr><th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr></thead><tbody><tr>`;
    
    // 첫째 날 이전의 빈 칸 채우기
    for (let i = 0; i < firstDay.getDay(); i++) {
        html += `<td class="other-month"></td>`;
    }

    // 날짜 채우기
    for (let date = 1; date <= lastDay.getDate(); date++) {
        const currentDate = new Date(year, month - 1, date);
        if (currentDate.getDay() === 0 && date !== 1) { // 일요일이면 새 행 시작
            html += `</tr><tr>`;
        }

        const dateString = `${year}-${String(month).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
        const dailyPlans = plans.filter(p => p.date === dateString);
        
        html += `<td><span class="day-number">${date}</span><div class="plan-item-wrapper">`;
        dailyPlans.forEach(p => {
            html += `<div class="plan-item" title="${p.itemName} | 수량: ${formatNumberWithCommas(p.quantity)}">${p.itemName.substring(0, 10)}...</div>`;
        });
        html += `</div></td>`;
    }

    // 마지막 날 이후의 빈 칸 채우기
    for (let i = lastDay.getDay() + 1; i < 7; i++) {
        html += `<td class="other-month"></td>`;
    }

    html += `</tr></tbody></table>`;
    calendarDiv.innerHTML = html;
  }
</script>
