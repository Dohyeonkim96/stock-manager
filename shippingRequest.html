<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>재고 관리 시스템 - 출고 요청</title>
    <link rel="stylesheet" href="styles-v2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar"></aside>
        <main class="main-content">
            <header class="main-header"><h1>출고 요청</h1></header>
            <div class="content-box">
                <h3>신규 출고 요청</h3>
                <form id="shipping-request-form" class="form-grid">
                    <div class="form-group"><label for="product-name">제품명</label><select id="product-name" name="productName" required><option value="">제품을 선택하세요</option></select></div>
                    <div class="form-group"><label for="quantity">요청 수량</label><input type="number" id="quantity" name="quantity" min="1" required></div>
                    <div class="form-group"><label for="shipping-date">출고 요청일</label><input type="date" id="shipping-date" name="shippingDate" required></div>
                    <div class="form-group"><label for="client-name">거래처명</label><input type="text" id="client-name" name="clientName" required></div>
                    <div class="form-group"><label for="site-name">현장명</label><input type="text" id="site-name" name="siteName"></div>
                    <div class="form-actions"><button type="submit" class="submit-btn">요청 제출</button></div>
                </form>
            </div>
            <div class="content-box">
                <h3>출고 요청 현황</h3>
                <table class="data-table">
                    <thead><tr><th>요청일</th><th>제품명</th><th>요청수량</th><th>거래처</th><th>현장명</th><th>상태</th></tr></thead>
                    <tbody id="request-list-body"><tr><td colspan="6" class="loading-row">로딩 중...</td></tr></tbody>
                </table>
            </div>
        </main>
    </div>
    <script src="utils-v2.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar('shippingRequest.html');
            document.getElementById('shipping-date').valueAsDate = new Date();
            loadInitialData();
            document.getElementById('shipping-request-form').addEventListener('submit', submitRequest);
        });
        async function loadInitialData() { await Promise.all([loadProductList(), loadShippingRequests()]); }
        async function loadProductList() {
            const productSelect = document.getElementById('product-name');
            try {
                const response = await fetch('/.netlify/functions/getProductInfo'); 
                if (!response.ok) throw new Error('제품 목록 로딩 실패');
                const products = await response.json();
                productSelect.innerHTML = '<option value="">제품을 선택하세요</option>';
                products.forEach(product => productSelect.innerHTML += `<option value="${product['제품명']}">${product['제품명']}</option>`);
            } catch (error) { console.error('Error fetching products:', error); productSelect.innerHTML = '<option value="">제품을 불러올 수 없습니다</option>'; }
        }
        async function loadShippingRequests() {
            const tableBody = document.getElementById('request-list-body');
            tableBody.innerHTML = '<tr><td colspan="6" class="loading-row">로딩 중...</td></tr>';
            try {
                const response = await fetch('/.netlify/functions/getShippingSummary');
                if (!response.ok) throw new Error('Network response was not ok');
                const requests = await response.json();
                tableBody.innerHTML = '';
                if (requests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="no-data-row">출고 요청 내역이 없습니다.</td></tr>';
                    return;
                }
                requests.sort((a, b) => new Date(b['출고 요청일']) - new Date(a['출고 요청일']));
                requests.forEach(req => {
                    let statusClass = { '출고요청': 'status-requested', '출고승인': 'status-confirmed', '출고완료': 'status-shipped', '요청취소': 'status-cancelled' }[req['상태']] || '';
                    tableBody.innerHTML += `<tr><td>${req['출고 요청일'] || ''}</td><td>${req['제품명'] || ''}</td><td>${req['요청수량'] || 0}</td><td>${req['거래처명'] || ''}</td><td>${req['현장명'] || ''}</td><td class="${statusClass}">${req['상태'] || ''}</td></tr>`;
                });
            } catch (error) { console.error('Error fetching shipping requests:', error); tableBody.innerHTML = '<tr><td colspan="6" class="error-row">데이터를 불러오는 데 실패했습니다.</td></tr>'; }
        }
        async function submitRequest(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; submitButton.textContent = '제출 중...';
            const formData = { productName: form.productName.value, quantity: parseInt(form.quantity.value, 10), shippingDate: form.shippingDate.value, clientName: form.clientName.value, siteName: form.siteName.value };
            try {
                const response = await fetch('/.netlify/functions/submitShipmentRequest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '알 수 없는 오류가 발생했습니다.');
                alert('출고 요청이 성공적으로 제출되었습니다.');
                form.reset(); document.getElementById('shipping-date').valueAsDate = new Date();
                await loadShippingRequests();
            } catch (error) { console.error('Error submitting request:', error); alert(`오류: ${error.message}`); }
            finally { submitButton.disabled = false; submitButton.textContent = '요청 제출'; }
        }
    </script>
</body>
</html>
