<style>
  .item-card { background-color: #fff; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-lg); }
  .item-card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--spacing-md); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color); }
  .item-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-md); }
  .validation-message { font-size: 11px; color: var(--danger-color); height: 14px; margin-top:4px; }
  @media (min-width: 768px) { .item-grid { grid-template-columns: repeat(2, 1fr); } }
  .action-buttons { margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; }
</style>

<div class="section-card">
  <h1 class="page-main-title">출고 요청</h1>
  <div id="messageArea" class="message"></div>
  <div id="item-rows-container"></div>
  <div class="action-buttons">
    <button class="button-secondary" onclick="addRequestItemRow()">품목 추가</button>
    <button class="button-primary" onclick="submitShipment()">출고 요청 등록<span id="submit-spinner" class="loading-spinner"></span></button>
  </div>
</div>
<script>
  const requestState = { itemCounter: 0, rowDataStore: {} };
  (function() { addRequestItemRow(); })();
  
  function addRequestItemRow() {
    requestState.itemCounter++;
    const rowId = requestState.itemCounter;
    const newCard = document.createElement("div");
    newCard.className = "item-card";
    newCard.id = `item-card-${rowId}`;
    newCard.innerHTML = `
      <div class="item-card-header"><h3>출고 품목 ${rowId}</h3></div>
      <div class="item-grid">
        <div class="form-group"><label>요청일</label><input type="date" name="shippingDate" class="editable" value="${new Date().toISOString().slice(0, 10)}"></div>
        <div class="form-group"><label>품목코드*</label><input type="text" name="itemCode" class="editable" onchange="fetchItemDetails(${rowId})" placeholder="유한품번 입력"></div>
        <div class="form-group"><label>LOT번호*</label><select name="lot" class="editable" onchange="onLotChange(${rowId})" disabled><option value="">품목코드 먼저 입력</option></select></div>
        <div class="form-group"><label>제품명</label><input type="text" name="itemName" readonly></div>
        <div class="form-group"><label>수량*</label><input type="number" name="quantity" class="editable" oninput="validateAndCalculate(${rowId})" min="1" disabled><div name="validation-msg" class="validation-message"></div></div>
        <div class="form-group"><label>입수</label><input type="text" name="packSize" readonly></div>
        <div class="form-group"><label>BOX수량</label><input type="text" name="boxQty" readonly></div>
        <div class="form-group"><label>제조일자</label><input type="date" name="mfgDate" readonly></div>
        <div class="form-group"><label>파렛트수량</label><input type="text" name="palletQty" readonly></div>
        <div class="form-group"><label>유통기한</label><input type="date" name="expDate" readonly></div>
      </div>`;
    document.getElementById("item-rows-container").appendChild(newCard);
  }
  
  async function fetchItemDetails(rowId) {
    const row = document.getElementById(`item-card-${rowId}`);
    const itemCode = row.querySelector(`[name="itemCode"]`).value.trim();
    const lotSelect = row.querySelector(`[name="lot"]`);
    if (!itemCode) return;
    showMessage("품목 정보 조회 중...", "info");
    try {
        const response = await fetch(`/.netlify/functions/getInventoryDetailsByYuhanCode?yuhanCode=${itemCode}`);
        const data = await response.json();
        if(!response.ok) throw new Error(data.error);

        requestState.rowDataStore[rowId] = data;
        row.querySelector(`[name="itemName"]`).value = data.staticInfo.itemName;
        row.querySelector(`[name="packSize"]`).value = data.staticInfo.packSize;
        
        lotSelect.innerHTML = '<option value="">LOT를 선택하세요</option>';
        data.lots.forEach((lot, index) => {
          lotSelect.add(new Option(`${lot.lotNumber} (재고: ${formatNumberWithCommas(lot.quantity)})`, index));
        });
        lotSelect.disabled = false;
        showMessage("품목 정보 조회 완료. LOT를 선택하세요.", "success");
    } catch(err) {
        showMessage(`조회 실패: ${err.message}`, "error");
    }
  }
  
  // onLotChange, validateAndCalculate, submitShipment 함수는 기존과 유사하게 유지
  function onLotChange(rowId) { /* ... */ }
  function validateAndCalculate(rowId) { /* ... */ }
  async function submitShipment() { /* ... */ }
</script>
