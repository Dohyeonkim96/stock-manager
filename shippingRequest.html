const Airtable = require('airtable');
const base = new Airtable({ apiKey: process.env.AIRTABLE_API_KEY }).base(process.env.AIRTABLE_BASE_ID);
const parseNumber = (str) => Number(String(str || '0').replace(/,/g, ''));

exports.handler = async function(event, context) {
  const { yuhanCode } = event.queryStringParameters;
  if (!yuhanCode) {
    return { statusCode: 400, body: JSON.stringify({ error: '유한품번이 필요합니다.' }) };
  }

  try {
    const [itemInfoRecords, stockRecords] = await Promise.all([
      base('기본정보').select({ filterByFormula: `{유한 품번} = '${yuhanCode}'`, maxRecords: 1 }).firstPage(),
      base('재고조회').select({ filterByFormula: `{품목코드} = '${yuhanCode}'` }).all()
    ]);

    if (stockRecords.length === 0) {
      return { statusCode: 404, body: JSON.stringify({ error: `품번 '${yuhanCode}'에 대한 재고가 없습니다.` }) };
    }

    const staticInfo = {
      itemName: itemInfoRecords[0]?.fields['품명'] || stockRecords[0].fields['제품명'],
      packSize: itemInfoRecords[0]?.fields['입수량'],
      itemsPerPallet: itemInfoRecords[0]?.fields['1PLT']
    };

    const lots = stockRecords.map(r => ({
      lotNumber: r.fields.LOT,
      quantity: parseNumber(r.fields['수량']),
      mfgDate: r.fields['제조일자'],
      expDate: r.fields['유통기한'],
      airtableRecordId: r.id
    }));

    return { statusCode: 200, body: JSON.stringify({ staticInfo, lots }) };
  } catch (error) {
    return { statusCode: 500, body: JSON.stringify({ error: error.message }) };
  }
};
