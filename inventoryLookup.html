<style>
  .filter-controls { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; margin-bottom: 24px; padding: 16px; background-color: #fdfdfe; border: 1px solid var(--border-color); border-radius: 0.375rem; }
  .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.875rem; }
  .data-table th, .data-table td { border-bottom: 1px solid var(--border-color); padding: 8px 16px; text-align: left; white-space: nowrap; vertical-align: middle; }
  .data-table th { background-color: #f8f9fa; font-weight: 700; color: #6c757d; text-align: center; border-top: 1px solid var(--border-color); }
  .data-table td.number { text-align: right; }
  .data-table .clickable-item-name { color: #0d6efd; text-decoration: underline; cursor: pointer; font-weight: 500; }
  .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(30, 41, 59, 0.6); }
  .modal-content { background-color: #ffffff; margin: 8% auto; padding: 24px 32px; border-radius: 0.375rem; width: 90%; max-width: 850px; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
</style>
<div class="section-card">
  <h1 class="page-main-title">재고 현황 조회</h1>
  <div class="filter-controls">
    <div class="form-group" style="margin-bottom:0;"><label for="categoryFilterSelect">분류 선택:</label><select id="categoryFilterSelect" onchange="renderInventorySummaryTable()"></select></div>
  </div>
  <div id="loading" class="loading-spinner" style="display:block; margin: 32px auto;"></div>
  <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>분류</th><th>품목코드</th><th style="min-width: 200px; text-align:left;">제품명</th><th class="number">총 수량</th></tr></thead><tbody id="inventoryTableBody"></tbody></table></div>
</div>
<div id="inventoryDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalDetailTitle"></h3><span class="close-button" onclick="closeModal('inventoryDetailModal')">&times;</span>
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="data-table">
                <thead><tr><th>LOT</th><th class="number">수량</th><th>제조일자</th><th>유통기한</th><th>비고</th></tr></thead>
                <tbody id="inventoryLotDetailTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
<script>
  let inventoryDataStore = [];
  (async function() {
    document.getElementById('loading').style.display = 'block';
    showMessage('재고 데이터를 조회하고 있습니다...', 'info');
    try {
      const response = await fetch('/.netlify/functions/getInventoryDetails');
      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.message || '서버 연결 실패');
      }
      const data = await response.json();
      inventoryDataStore = data || [];
      const classifications = [...new Set(data.map(item => item.classification || '미분류'))].sort();
      const select = document.getElementById('categoryFilterSelect');
      select.innerHTML = '<option value="">전체 분류 보기</option>';
      classifications.forEach(cat => select.add(new Option(cat, cat)));
      renderInventorySummaryTable();
    } catch (err) {
      showMessage('조회 오류: ' + err.message, 'error');
    } finally {
      document.getElementById('loading').style.display = 'none';
    }
  })();
  function renderInventorySummaryTable() {
    const selectedCat = document.getElementById('categoryFilterSelect').value;
    const tableBody = document.getElementById('inventoryTableBody');
    tableBody.innerHTML = '';
    const dataToRender = selectedCat ? inventoryDataStore.filter(item => item.classification === selectedCat) : inventoryDataStore;
    if (dataToRender.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">데이터 없음</td></tr>`;
      return;
    }
    dataToRender.forEach(item => {
      tableBody.insertRow().innerHTML = `<td>${item.classification}</td><td>${item.itemCode}</td><td style="text-align:left;"><span class="clickable-item-name" onclick="showLotDetailsModal('${item.itemCode}')">${item.itemName}</span></td><td class="number">${formatNumberWithCommas(item.totalQuantity)}</td>`;
    });
  }
  function showLotDetailsModal(itemCode) {
    const item = inventoryDataStore.find(i => i.itemCode === itemCode);
    if (!item) return;
    document.getElementById('modalDetailTitle').textContent = item.itemName;
    const lotTbody = document.getElementById('inventoryLotDetailTableBody');
    lotTbody.innerHTML = '';
    if (item.lots && item.lots.length > 0) {
        item.lots.forEach(lot => {
            lotTbody.insertRow().innerHTML = `<td>${lot.lot || '-'}</td><td class="number">${formatNumberWithCommas(lot.quantity)}</td><td>${lot.mfgDate || '-'}</td><td>${lot.expDate || '-'}</td><td>${lot.remarks || '-'}</td>`;
        });
    } else {
        lotTbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">LOT 정보가 없습니다.</td></tr>`;
    }
    document.getElementById('inventoryDetailModal').style.display = 'block';
  }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
