<style>
  .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; align-items: flex-end; margin-bottom: 16px; padding: 16px; background-color: #fdfdfe; border: 1px solid #dee2e6; border-radius: 0.375rem; }
  .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.875rem; }
  .data-table th, .data-table td { border-bottom: 1px solid #dee2e6; padding: 8px 16px; text-align: right; white-space: nowrap; vertical-align: middle; }
  .data-table th { background-color: #f8f9fa; font-weight: 700; text-align: center; }
  .data-table tfoot { font-weight: bold; background-color: #f1f3f4; }
  .data-table th:nth-child(-n+3), .data-table td:nth-child(-n+3) { text-align: left; }
  .data-table .clickable-item-name { color: #0d6efd; text-decoration: underline; cursor: pointer; }
  .data-table .balance-cell { font-weight: bold; color: #dc3545; }
</style>
<div class="section-card">
  <h1 class="page-main-title">PO(발주) 현황</h1>
  <div id="messageArea" class="message"></div>
  <div class="filter-controls">
      <div class="form-group"><label for="bu-filter">사업부</label><select id="bu-filter" onchange="fetchPoStatus()"></select></div>
      <div class="form-group"><label>유한품번</label><input type="text" id="pn-filter" class="editable" placeholder="품번으로 검색"></div>
      <div class="form-group"><button class="button-secondary" onclick="fetchPoStatus()">조회 <span id="loading-spinner" class="loading-spinner"></span></button></div>
  </div>
  <div style="overflow-x: auto;">
    <table class="data-table">
      <thead><tr><th>유한품번</th><th>지에스켐 품번</th><th>품명</th><th>총 발주량</th><th>누적 납품량</th><th>PO 잔량</th></tr></thead>
      <tbody id="po-status-tbody"></tbody>
      <tfoot id="po-status-tfoot"></tfoot>
    </table>
  </div>
</div>
<script>
  let poStatusDataStore = [];
  (async function() { await fetchPoStatus(); })();
  async function fetchPoStatus() {
    const spinner = document.getElementById('loading-spinner');
    spinner.style.display = 'inline-block';
    showMessage('데이터 조회 중...', 'info');
    const filters = {
      yuhanPartNo: document.getElementById('pn-filter').value.trim(),
      businessUnit: document.getElementById('bu-filter').value || ''
    };
    try {
      const response = await fetch(`/.netlify/functions/getPoStatusDetails?${new URLSearchParams(filters)}`);
      if (!response.ok) throw new Error('서버 연결 실패');
      const data = await response.json();
      poStatusDataStore = data.results || [];
      
      const buFilter = document.getElementById('bu-filter');
      if (buFilter.length <= 1) {
          buFilter.innerHTML = '<option value="">전체 사업부</option>';
          (data.businessUnits || []).forEach(bu => buFilter.add(new Option(bu, bu)));
      }
      renderPoStatusTable(poStatusDataStore);
      showMessage('조회 완료', 'success');
    } catch (err) {
      showMessage('조회 오류: ' + err.message, 'error');
    } finally {
      spinner.style.display = 'none';
    }
  }
  function renderPoStatusTable(data) {
    const tbody = document.getElementById('po-status-tbody');
    const tfoot = document.getElementById('po-status-tfoot');
    tbody.innerHTML = "";
    tfoot.innerHTML = "";
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">발주 내역 없음</td></tr>';
      return;
    }
    const totalBalance = data.reduce((sum, item) => sum + item.balance, 0);
    data.forEach(item => {
      tbody.insertRow().innerHTML = `<td>${item.itemCode}</td><td>${item.gskemPN || ''}</td><td>${item.itemName}</td><td>${formatNumberWithCommas(item.totalOrdered)}</td><td>${formatNumberWithCommas(item.cumulativeDelivered)}</td><td class="balance-cell">${formatNumberWithCommas(item.balance)}</td>`;
    });
    tfoot.insertRow().innerHTML = `<td colspan="5" style="text-align: center;">PO 잔량 합계</td><td class="balance-cell">${formatNumberWithCommas(totalBalance)}</td>`;
  }
</script>
