<style>
  .filter-controls { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; margin-bottom: 24px; padding: 16px; background-color: #fdfdfe; border: 1px solid var(--border-color); border-radius: 0.375rem; }
  .data-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); }
  .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }
  .data-table tfoot { font-weight: bold; }
  .data-table .clickable-quantity { color: var(--primary-color); text-decoration: underline; cursor: pointer; font-weight: bold; }
  .modal-content { max-width: 800px; }
</style>

<div class="section-card">
  <h1 class="page-main-title">납품 이력 조회</h1>
  <div class="filter-controls">
    <div class="form-group" style="margin-bottom:0;"><label for="year-filter">년도</label><select id="year-filter"></select></div>
    <div class="form-group" style="margin-bottom:0;"><label for="month-filter">월</label><select id="month-filter"></select></div>
    <div class="form-group" style="margin-bottom:0;"><label for="item-code-filter">품목코드</label><input type="text" id="item-code-filter" class="editable" placeholder="품목코드로 검색"></div>
    <button onclick="searchHistory()" class="button-primary">조회 <span id="loading" class="loading-spinner"></span></button>
  </div>
  <div style="overflow-x: auto;">
    <table class="data-table">
      <thead><tr><th>품목코드</th><th style="min-width: 200px; text-align:left;">품명</th><th>총 납품수량</th></tr></thead>
      <tbody id="history-tbody"></tbody>
      <tfoot id="history-tfoot"></tfoot>
    </table>
  </div>
</div>
<div id="lot-detail-modal" class="modal">
  <div class="modal-content">
      <h2 id="modal-title">상세 내역</h2>
      <span class="close-button" onclick="closeModal('lot-detail-modal')" style="position: absolute; top: 10px; right: 20px; font-size: 28px; cursor: pointer;">&times;</span>
      <div style="overflow-x: auto;">
        <table class="data-table">
          <thead><tr><th>납품일자</th><th>LOT</th><th>납품수량</th></tr></thead>
          <tbody id="lot-detail-tbody"></tbody>
        </table>
      </div>
  </div>
</div>

<script>
  let fullHistoryData = [];
  (function() {
    const yearSelect = document.getElementById('year-filter');
    const monthSelect = document.getElementById('month-filter');
    const currentYear = new Date().getFullYear();
    for(let i=currentYear; i >= currentYear - 5; i--) yearSelect.add(new Option(i + '년', i));
    monthSelect.innerHTML = '<option value="">전체 월</option>';
    for (let i = 1; i <= 12; i++) monthSelect.add(new Option(i + '월', i));
    yearSelect.value = currentYear;
    monthSelect.value = new Date().getMonth() + 1;
    searchHistory();
  })();

  async function searchHistory() {
    document.getElementById('loading').style.display = 'inline-block';
    showMessage('데이터를 조회하고 있습니다...', 'info');
    
    const filters = {
      year: document.getElementById('year-filter').value,
      month: document.getElementById('month-filter').value,
      itemCode: document.getElementById('item-code-filter').value.trim()
    };
    const queryParams = new URLSearchParams(filters);
    
    try {
        const response = await fetch(`/.netlify/functions/getDeliveryHistory?${queryParams}`);
        const data = await response.json();
        if(!response.ok) throw new Error(data.error);

        fullHistoryData = data || [];
        renderHistoryTable(fullHistoryData);
    } catch(err) {
        showMessage('데이터 조회 오류: ' + err.message, 'error');
        renderHistoryTable([]);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
  }
  
  function renderHistoryTable(data) {
      const tbody = document.getElementById('history-tbody');
      const tfoot = document.getElementById('history-tfoot');
      tbody.innerHTML = ''; tfoot.innerHTML = '';
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">조회된 데이터가 없습니다.</td></tr>';
        return;
      }
      const grandTotal = data.reduce((sum, item) => sum + item.grandTotalQuantity, 0);
      data.forEach(item => {
        tbody.insertRow().innerHTML = `
          <td>${item.itemCode}</td>
          <td style="text-align:left;">${item.itemName}</td>
          <td class="number"><span class="clickable-quantity" onclick="showLotDetails('${item.itemCode}')">${formatNumberWithCommas(item.grandTotalQuantity)}</span></td>`;
      });
      tfoot.insertRow().innerHTML = `<td colspan="2" style="text-align: center;">총 합계</td><td class="number">${formatNumberWithCommas(grandTotal)}</td>`;
      // [수정] 조회 완료 팝업 제거
  }

  function showLotDetails(itemCode) {
    const itemData = fullHistoryData.find(item => item.itemCode === itemCode);
    if (!itemData) return;
    document.getElementById('modal-title').textContent = `[${itemData.itemName}] 상세 납품 내역`;
    const lotTbody = document.getElementById('lot-detail-tbody');
    lotTbody.innerHTML = '';
    itemData.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
      lotTbody.insertRow().innerHTML = `<td>${tx.date || '-'}</td><td>${tx.lot || '-'}</td><td class="number">${formatNumberWithCommas(tx.quantity)}</td>`;
    });
    document.getElementById('lot-detail-modal').style.display = 'block';
  }
  
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
