<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입고관리 - 통합 재고관리 시스템</title>
    <link rel="stylesheet" href="/styles-v2.css">
    <script src="https://kit.fontawesome.com/a2309d579f.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header>
                <h1>입고 관리</h1>
            </header>

            <div class="form-container card">
                <form id="receivingForm">
                    <div class="form-group">
                        <label for="poNumber">발주번호</label>
                        <input type="text" id="poNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="itemCode">품목코드</label>
                        <input type="text" id="itemCode" readonly>
                    </div>
                    <div class="form-group">
                        <label for="itemName">품명</label>
                        <input type="text" id="itemName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="quantity">입고수량</label>
                        <input type="number" id="quantity" required>
                    </div>
                    <div class="form-group">
                        <label for="receivingDate">입고일</label>
                        <input type="date" id="receivingDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary">입고 처리</button>
                </form>
            </div>

             <div class="table-container card">
                <h2>최근 입고 내역</h2>
                <table id="recentReceivingTable">
                    <thead>
                        <tr>
                            <th>발주번호</th>
                            <th>품목코드</th>
                            <th>품명</th>
                            <th>수량</th>
                            <th>입고일</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </main>
    </div>
    <script src="utils-v2.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 네비게이션 로드
            loadNavigation('stockReceiving');

            const poNumberInput = document.getElementById('poNumber');
            const itemCodeInput = document.getElementById('itemCode');
            const itemNameInput = document.getElementById('itemName');
            const receivingForm = document.getElementById('receivingForm');
            const receivingDateInput = document.getElementById('receivingDate');
            const recentTableBody = document.querySelector('#recentReceivingTable tbody');

            // 오늘 날짜를 기본값으로 설정
            receivingDateInput.valueAsDate = new Date();

            // 발주번호 입력 시 발주 정보 자동 완성
            poNumberInput.addEventListener('blur', async () => {
                const poNumber = poNumberInput.value.trim();
                if (!poNumber) return;

                try {
                    const response = await fetch(`/.netlify/functions/getPoStatusDetails?poNumber=${poNumber}`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const item = data[0].fields;
                        itemCodeInput.value = item['품목코드'] || '';
                        itemNameInput.value = item['품명'] || '';
                    } else {
                        alert('해당 발주번호를 찾을 수 없습니다.');
                        itemCodeInput.value = '';
                        itemNameInput.value = '';
                    }
                } catch (error) {
                    console.error('발주 정보 조회 실패:', error);
                    alert('발주 정보를 가져오는 데 실패했습니다.');
                }
            });

            // 입고 처리 폼 제출
            receivingForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const receivingData = {
                    poNumber: poNumberInput.value,
                    itemCode: itemCodeInput.value,
                    itemName: itemNameInput.value,
                    quantity: document.getElementById('quantity').value,
                    receivingDate: receivingDateInput.value
                };

                try {
                    const response = await fetch('/.netlify/functions/createStockReceiving', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(receivingData)
                    });

                    if (response.ok) {
                        alert('입고 처리가 완료되었습니다.');
                        receivingForm.reset();
                        receivingDateInput.valueAsDate = new Date(); // 날짜 초기화
                        fetchRecentReceivings(); // 최근 내역 갱신
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || '입고 처리 실패');
                    }
                } catch (error) {
                    console.error('입고 처리 오류:', error);
                    alert(`오류 발생: ${error.message}`);
                }
            });

            // 최근 입고 내역 조회 함수
            function fetchRecentReceivings() {
                showLoading('recentReceivingTable');
                fetch('/.netlify/functions/getRecentReceivings') // 최근 5건 정도 가져오는 함수라 가정
                    .then(response => response.json())
                    .then(data => {
                        recentTableBody.innerHTML = '';
                        if(data.length === 0) {
                            showMessage('recentReceivingTable', '최근 입고 내역이 없습니다.');
                            return;
                        }
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.fields['발주번호'] || ''}</td>
                                <td>${item.fields['품목코드'] || ''}</td>
                                <td>${item.fields['품명'] || ''}</td>
                                <td>${item.fields['수량'] || ''}</td>
                                <td>${item.fields['입고일'] || ''}</td>
                            `;
                            recentTableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('recentReceivingTable', '데이터를 불러오는 중 오류가 발생했습니다.');
                    });
            }

            // 페이지 로드 시 최근 입고 내역 조회
            fetchRecentReceivings();
        });
    </script>
</body>
</html>
